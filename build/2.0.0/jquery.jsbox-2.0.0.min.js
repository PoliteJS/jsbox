/* JSBox v2.0.0 | by Marco Pegoraro | http://politejs.com/jsbox */

(function($) {
    function subscribe(a,b,c){a._subscriptions||(a._subscriptions={}),a._subscriptions[b]||(a._subscriptions[b]=[]),a._subscriptions[b].push(c)}function publish(a,b){var c=Array.prototype.slice.call(arguments);c.shift(),c.shift(),a._subscriptions&&a._subscriptions[b]&&a._subscriptions[b].forEach(function(b){b.apply(a,c)})}function loadSourceCode(a){a.source=!a.config.code&&a.config.codeQuery?a.$el.find(a.config.codeQuery).text():a.config.code,a._originalSource=a.source}function loadTestCode(a){!a.config.tests.length&&a.config.testsQuery?(a.tests=[],a.$el.find(a.config.testsQuery).each(function(){a.tests.push($(this).text())})):a.tests=a.config.tests}function initDOM(a){a._originalHTML=a.$el.html(),a.$el.empty().addClass("jsbox-widget"),a.$editor=$('<div class="jsbox-editor">'),a.$tests=$('<ul class="jsbox-test">'),a.tests.forEach(function(b){a.$tests.append($("<li>").text(b))}),a.$sandbox=$('<div class="jsbox-sandbox">'),a.$exception=$('<div class="jsbox-exception">'),a.$console=$('<ul class="jsbox-console">'),a.$runBtn=$("<button>").text("run"),a.$resetBtn=$("<button>").text("reset"),a.$runBtn.on("click",a.run.bind(a)),a.$resetBtn.on("click",a.reset.bind(a)),a.$overlay=$('<div class="jsbox-overlay">'),a.$overlay.append("<p>solve the previous exercise to unlock!</p>"),a.$el.append(a.$tests).append(a.$editor).append(a.$sandbox).append(a.$exception).append(a.$console).append(a.$runBtn).append(a.$resetBtn).append(a.$overlay)}function disposeDOM(a){a.$runBtn.off(),a.$resetBtn.off(),a.$el.empty().removeClass("jsbox-widget").html(a._originalHTML)}function initEditor(a){var b=a.config.editor||defaultEditor;a.editor=Object.create(b),a.editor.init(a.$editor,a.setSource.bind(a),a.source,a.config.updateDelay),a.editor.on("cmd-run",a.run.bind(a)),a.editor.on("cmd-reset",a.reset.bind(a))}function disposeEditor(a){a.editor.dispose(),a.editor=null}function initSandbox(a){var b=a.config.sandbox||defaultSandbox;a.sandbox=Object.create(b),a.sandbox.init(a.$sandbox[0]),a.sandbox.on("start",function(){a.$tests.addClass("running")}),a.sandbox.on("stop",function(){a.$tests.removeClass("running")}),a.sandbox.on("success",function(b){a.$tests.find(":eq("+b+")").addClass("success")}),a.sandbox.on("failure",function(b){a.$tests.find(":eq("+b+")").addClass("failure")}),a.sandbox.on("reset",function(){a.$exception.html("").hide(),a.$console.html("").hide(),a.$tests.find(".success").removeClass("success"),a.$tests.find(".failure").removeClass("failure")}),a.sandbox.on("exception",function(b){a.$exception.html(b.message).show()}),a.sandbox.on("console",function(b,c){$("<li>").addClass(b).text(c).appendTo(a.$console),a.$console.show()}),a.sandbox.reset()}function disposeSandbox(a){a.sandbox.dispose(),a.sandbox=null}function init(a){var b=$(this);if(!b.data("jsbox")||b.data("jsbox")===!0){a=$.extend({},a,{next:b.attr("data-jsbox-next")||""});var c=Object.create(JSBox);if(c.init(this,a),b.data("jsbox",c),a.next){var d;$(document).delegate(a.next,"jsbox-ready",function(a,b){d=b,d.disable()}),c.on("status",function(a){a&&d&&d.enable()})}b.trigger("jsbox-ready",c)}}function dispose(){var a=$(this).data("jsbox");a&&(a.dispose(),a=null,$.removeData(this,"jsbox"))}var defaultEditor=function(){function a(a){a.css("height","auto"),a.css("height",a[0].scrollHeight+15+"px")}var b={init:function(b,c,d,e){var f,g=this,e=e||250;this.$ui=$('<textarea class="jsbox-default-editor" wrap="off" placeholder="CMD+Return to execute, CMD+Backspace to reset">').appendTo(b),this.$ui.on("keydown",function(a){var b=a.keyCode||a.which;if(9==b){a.preventDefault();var c=$(this).get(0).selectionStart,d=$(this).get(0).selectionEnd;$(this).val($(this).val().substring(0,c)+"  "+$(this).val().substring(d)),$(this).get(0).selectionStart=$(this).get(0).selectionEnd=c+2}(13==b&&a.ctrlKey||13==b&&a.metaKey)&&(a.preventDefault(),a.stopPropagation(),publish(g,"cmd-run")),(27==b&&a.ctrlKey||27==b&&a.metaKey)&&(a.preventDefault(),a.stopPropagation(),publish(g,"cmd-reset")),(8==b&&a.ctrlKey||8==b&&a.metaKey)&&(a.preventDefault(),a.stopPropagation(),publish(g,"cmd-reset"))}),this.$ui.on("keyup",function(){clearTimeout(f),f=setTimeout(function(){c(g.getSource())},e)}),a(g.$ui);var h;this.$ui.on("keydown change",function(){clearTimeout(h),h=setTimeout(function(){a(g.$ui)},500)}),this.setSource(d)},on:function(a,b){subscribe(this,a,b)},dispose:function(){this.$ui.off().remove(),this.$ui=null},getSource:function(){return this.$ui.val()},setSource:function(a){return this.$ui.val(a),this}};return b}(),defaultSandbox=function(){function a(a,d,e,f,g,h){function i(a,b){var b=Array.prototype.slice.call(b);f("console",a,c(b),b)}function j(){var c=!0;e.forEach(function(a,d){m.sandboxTestResultsHandler=function(b){g.call(m,a,d,b),c=c&&b},b("try {sandboxTestResultsHandler("+a+");} catch (e) {sandboxTestResultsHandler(false);}",n)}),a.removeChild(k),h(c)}var k=document.createElement("iframe");a.appendChild(k);var l=!1,m=k.contentWindow,n=m.document.body,d="try {"+d+"} catch(e) { sandboxCatchErrors(e); }";m.sandboxCatchErrors=function(a){f("exception",a)},m.console={log:function(){i("log",arguments)},warn:function(){i("warn",arguments)},error:function(){i("error",arguments)}},m.async=function(){return l=!0,j},b(d,n),l||j()}function b(a,b){var c=document.createElement("script");return c.type="text/javascript",c.appendChild(document.createTextNode(a)),b&&b.appendChild(c),c}function c(a){return a.map(d).join(", ")}function d(a){switch(typeof a){case"string":return'"'+a+'"';case"object":return"[object Date]"===Object.prototype.toString.call(a)?a.toString():Array.isArray(a)?"["+a.map(d).join(", ")+"]":"{"+Object.keys(a).map(function(b){return b+":"+d(a[b])}).join(", ")+"}";case"function":return a.toString();case"boolean":return a.toString().toUpperCase()}return a}var e={init:function(a){this.el=a,_sandbox=this},dispose:function(){},on:function(a,b){subscribe(this,a,b)},reset:function(){return publish(this,"reset"),this},run:function(b,c,d){var e=this;try{{new Function(b)}}catch(f){return publish(this,"exception",f),void publish(this,"stop")}var g=function(){var a=Array.prototype.slice.call(arguments);a.unshift(e),publish.apply(null,a)};publish(this,"start"),a(this.el,b,c,g,function(a,b,c){publish(e,"stop"),publish(e,c?"success":"failure",b,a)},d)}};return e}(),JSBox={init:function(a,b){this.el=a,this.$el=$(this.el),this.config=b,this.status=!1,this.source="",loadSourceCode(this),this.tests=[],loadTestCode(this),initDOM(this),initEditor(this),initSandbox(this)},dispose:function(){disposeDOM(this),disposeEditor(this),disposeSandbox(this)},on:function(a,b){subscribe(this,a,b)},enable:function(){this.$el.removeClass("jsbox-disabled")},disable:function(){this.$el.addClass("jsbox-disabled")},setSource:function(a){this.source=a,this.editor.setSource(this.source)},reset:function(){this.sandbox.reset(),this.setSource(this._originalSource)},run:function(){var a=this;this.status=!1,this.sandbox.reset().run(this.source,this.tests,function(b){a.status=b,publish(a,"status",a.status)})}};$.jsboxDefaults={code:"",codeQuery:"code",tests:[],testsQuery:"ul>li",editor:null,sandbox:null,updateDelay:300},$.fn.jsbox=function(){var a=Array.prototype.slice.call(arguments);if(a.length)if($.isPlainObject(a[0])){var b=$.extend({},$.jsboxDefaults,a[0]);$(this).each(init,[b])}else switch(a[0]){case"instance":return $(this).data("jsbox");case"dispose":$(this).each(dispose);break;default:throw'JSBox does not support "'+a[0].toString()+'" API call'}else $(this).each(init,[$.jsboxDefaults]);return this},$(document).ready(function(){$("[data-jsbox]").jsbox()});
})(jQuery);
